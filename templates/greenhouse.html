{% extends "base.html" %}

{% block title %}Greenhouse Homepage{% endblock %}

{% block content %}

<h2>Welcome Back,</h2>
<h2>Greenhouse Details</h2>
<div class="card text-bg-dark" style="max-width: 50rem;">
    <img src="{{ url_for('static', filename='upload_imgs/current/now.jpg') }}" class="card-img" alt="current view">
    <div class="card-img-overlay">
        <h5 class="card-title">
            <div class="spinner-grow text-danger spinner-grow-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Current View
        </h5>
        <p class="card-text"><small id="timeCounter">Last updated 0 seconds ago</small></p>
    </div>
</div>
<br>
<table class="table table-striped caption-top">
    <caption>
        <div class="spinner-grow text-danger spinner-grow-sm" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        Live Stats
    </caption>
    <thead>
    <tr class="table-success">
        <th>Param</th>
        <th>Value</th>
    </tr>
    </thead>
    <tbody id="liveStats">
    <!-- Display each condition in the desired order -->
        <tr>
            <td>Temperature</td>
            <td>{{ conditions.temperature }} °C</td>
        </tr>
        <tr>
            <td>Humidity</td>
            <td>{{ conditions.humidity }} %</td>
        </tr>
        <tr>
            <td>CO2</td>
            <td>{{ conditions.co2 }} PPM</td>
        </tr>
        <tr>
            <td>TVOC</td>
            <td>{{ conditions.tvoc }} PPM</td>
        </tr>
        <tr>
            <td>Water Level</td>
            <td>{{ conditions.distance }} %</td>
        </tr>
        <tr>
            <td>Soil Moisture</td>
            <td>
                {% if conditions.soilMoisture == 1 %}
                Dry
                {% elif conditions.soilMoisture == 0 %}
                Wet
                {% else %}
                Unknown
                {% endif %}
            </td>
        </tr>
    </tbody>
</table>

<!--<a href="/greenhouse/conditions" class="btn btn-primary">Check Conditions</a>-->

<script>
    let startTime = new Date().getTime(); // Record the time when the page loads

    function updateTime() {
        let now = new Date().getTime(); // Get current time
        let elapsed = Math.floor((now - startTime) / 1000); // Time in seconds since page load

        // Update the timeCounter element with the new time
        document.getElementById('timeCounter').innerText = `Last updated ${elapsed} seconds ago`;
    }

    // Fetch the latest sensor data and update the table
    function fetchLiveStats() {
        fetch('/get_current') // Endpoint to fetch the latest sensor data
            .then(response => response.json())
            .then(data => {
                if (data.conditions) {
                    const conditions = data.conditions;

                    // Update table rows manually
                    document.querySelector("#liveStats").innerHTML = `
                        <tr>
                            <td>Temperature</td>
                            <td>${ conditions.temperature } °C</td>
                        </tr>
                        <tr>
                            <td>Humidity</td>
                            <td>${ conditions.humidity } %</td>
                        </tr>
                        <tr>
                            <td>CO2</td>
                            <td>${ conditions.co2 } PPM</td>
                        </tr>
                        <tr>
                            <td>TVOC</td>
                            <td>${ conditions.tvoc } PPM</td>
                        </tr>
                        <tr>
                            <td>Water Level</td>
                            <td>${ conditions.distance } %</td>
                        </tr>
                        <tr><td>Soil Moisture</td><td>${conditions.soilMoisture === 1 ? "Dry" : conditions.soilMoisture === 0 ? "Wet" : "Unknown"}</td></tr>
                    `;

                    // Reset the timer
                    startTime = new Date().getTime();
                } else {
                    console.error("Error: No conditions in response");
                }
            })
            .catch(error => {
                console.error("Error fetching live stats:", error);
            });
    }

    // Update the counter every second
    setInterval(updateTime, 1000);

    // Fetch live stats every 10 seconds
    setInterval(fetchLiveStats, 10000);

    // Fetch live stats immediately on page load
    fetchLiveStats();
</script>

{% endblock %}
